<h3>Updating Samba</h3>
<p>As mentioned earlier, there are two approaches to follow depending on the previous installation method:</p>
<p>If you installed Samba from your distribution’s repositories.</p>
<p>Let’s take a look at what you need to do in this case:</p>
<h4>Fix Sambacry in Debian</h4>
<p>Make sure <a href="https://www.tecmint.com/apt-advanced-package-command-examples-in-ubuntu/" target="_blank" rel="noopener noreferrer">apt</a> is set to get the latest security updates by adding the following lines to your sources list (<strong>/etc/apt/sources.list</strong>):</p>
<pre>deb http://security.debian.org stable/updates main
deb-src http://security.debian.org/ stable/updates main
</pre>
<p>Next, update the list of available packages:</p>
<pre># aptitude update
</pre>
<p>Finally, make sure the version of the samba package matches the version where the vulnerability has been fixed (see <a href="https://security-tracker.debian.org/tracker/CVE-2017-7494" target="_blank" rel="nofollow noopener noreferrer">CVE-2017-7494</a>):</p>
<pre># aptitude show samba
</pre>
<div id="attachment_25761" class="wp-caption aligncenter" style="width: 818px;"><img class="size-full wp-image-25761" style="display: inline;" src="https://www.tecmint.com/wp-content/uploads/2017/05/Fix-Sambacry-in-Debian.png" sizes="(max-width: 808px) 100vw, 808px" srcset="https://www.tecmint.com/wp-content/uploads/2017/05/Fix-Sambacry-in-Debian.png 808w, https://www.tecmint.com/wp-content/uploads/2017/05/Fix-Sambacry-in-Debian-768x407.png 768w" alt="Fix Sambacry in Debian" width="808" height="428" data-lazy-loaded="true" />
<p class="wp-caption-text">Fix Sambacry in Debian</p>
</div>
<h4>Fix Sambacry in Ubuntu</h4>
<p>To begin, check for new available packages and update the samba package as follows:</p>
<pre>$ sudo apt-get update
$ sudo apt-get install samba
</pre>
<p>The Samba versions where the fix for <strong>CVE-2017-7494</strong> has already been applied are the following:</p>
<ul>
<li>17.04: <strong>samba 2:4.5.8+dfsg-0ubuntu0.17.04.2</strong></li>
<li>16.10: <strong>samba 2:4.4.5+dfsg-2ubuntu5.6</strong></li>
<li>16.04 LTS: <strong>samba 2:4.3.11+dfsg-0ubuntu0.16.04.7</strong></li>
<li>14.04 LTS: <strong>samba 2:4.3.11+dfsg-0ubuntu0.14.04.8</strong></li>
</ul>
<p>Finally, run the following command to verify that your Ubuntu box now has the right Samba version installed.</p>
<pre>$ sudo apt-cache show samba
</pre>
<h4>Fix Sambacry on CentOS/RHEL 7</h4>
<p>The patched Samba version in <strong>EL 7</strong> is <strong>samba-4.4.4-14.el7_3</strong>. To install it, do</p>
<pre># yum makecache fast
# yum update samba
</pre>
<p>As before, make sure you have now the patched Samba version:</p>
<pre># yum info samba
</pre>
<div id="attachment_25762" class="wp-caption aligncenter" style="width: 407px;"><img class="size-full wp-image-25762" style="display: inline;" src="https://www.tecmint.com/wp-content/uploads/2017/05/Fix-Sambacry-in-CentOS.png" alt="Fix Sambacry in CentOS" width="397" height="423" data-lazy-loaded="true" />
<p class="wp-caption-text">Fix Sambacry in CentOS</p>
</div>
<p>Older, still supported versions of CentOS and RHEL have available fixes as well. Check <a href="https://rhn.redhat.com/errata/RHSA-2017-1270.html" target="_blank" rel="nofollow noopener noreferrer">RHSA-2017-1270</a> to find out more.</p>
<h5>If you installed Samba from source</h5>
<p><strong style="color: red;">Note</strong>: The following procedure assumes that you have previously built Samba from source. You are highly encouraged to try it out extensively in a testing environment BEFORE deploying it to a production server.</p>
<p>Additionally, make sure you back up the <strong>smb.conf</strong> file before you start.</p>
<p>In this case, we will compile and update Samba from source as well. Before we begin, however, we must ensure all the dependencies are previously installed. Note that this may take several minutes.</p>
<h4>In Debian and Ubuntu:</h4>
<pre># aptitude install acl attr autoconf bison build-essential \
debhelper dnsutils docbook-xml docbook-xsl flex gdb krb5-user \
libacl1-dev libaio-dev libattr1-dev libblkid-dev libbsd-dev \
libcap-dev libcups2-dev libgnutls28-dev libjson-perl \
libldap2-dev libncurses5-dev libpam0g-dev libparse-yapp-perl \
libpopt-dev libreadline-dev perl perl-modules pkg-config \
python-all-dev python-dev python-dnspython python-crypto xsltproc \
zlib1g-dev libsystemd-dev libgpgme11-dev python-gpgme python-m2crypto
</pre>
<h4>In CentOS 7 or similar:</h4>
<pre># yum install attr bind-utils docbook-style-xsl gcc gdb krb5-workstation \
libsemanage-python libxslt perl perl-ExtUtils-MakeMaker \
perl-Parse-Yapp perl-Test-Base pkgconfig policycoreutils-python \
python-crypto gnutls-devel libattr-devel keyutils-libs-devel \
libacl-devel libaio-devel libblkid-devel libxml2-devel openldap-devel \
pam-devel popt-devel python-devel readline-devel zlib-devel
</pre>
<p>Stop the service:</p>
<pre># systemctl stop smbd
</pre>
<p>Download and untar the source (with 4.6.4 being the latest version at the time of this writing):</p>
<pre># wget https://www.samba.org/samba/ftp/samba-latest.tar.gz 
# tar xzf samba-latest.tar.gz
# cd samba-4.6.4
</pre>
<p>For informative purposes only, check the available configure options for the current release with.</p>
<pre># ./configure --help
</pre>
<p>You may include some of the options returned by the above command if they were used in the previous build, or you may choose to go with the default:</p>
<pre># ./configure
# make
# make install
</pre>
<p>Finally, restart the service.</p>
<pre># systemctl restart smbd
</pre>
<p>and verify you’re running the updated version:</p>
<pre># smbstatus --version
</pre>
<p>which should return <strong>4.6.4</strong>.</p>
<h3>General Considerations</h3>
<p>If you are running an unsupported version of a given distribution and are unable to upgrade to a more recent one for some reason, you may want to take the following suggestions into account:</p>
<ul>
<li>If SELinux is enabled, you are protected!</li>
<li>Make sure Samba shares are mounted with the noexec option. This will prevent the execution of binaries residing on the mounted filesystem.</li>
</ul>
<p>Add,</p>
<pre>nt pipe support = no
</pre>
<p>to the [global] section of your <strong>smb.conf</strong> file and restart the service. You may want to keep in mind that this “may disable some functionality in Windows clients”, as per the Samba project.</p>
<p><strong style="color: red;">Important</strong>: Be aware that the option “<strong>nt pipe support = no</strong>” would disable shares listing from Windows clients. Eg: When you type <strong>\\10.100.10.2\</strong> from Windows Explorer on a samba server you would get a permission denied. Windows clients would have to manually specify the share as <strong>\\10.100.10.2\share_name</strong> to access the share.</p>
<h5> </h5>
<p> </p>
<p>https://www.tecmint.com/fix-sambacry-vulnerability-cve-2017-7494-in-linux/</p>