<p>Siccome Cloudflare funge da proxy di default nei log del webserver arrivano gli IP dei server di CF, e non quelli del visitatore reale. L&#39;IP originale viene messo da CF in un&#39;intestazione del pacchetto http, e bisogna istruire il webserver per prendere l&#39;IP da qui anziché dall&#39;indirizzo remoto.</p>
<p>È bene verificare ed aggiornare l&#39;elenco degli <a href="https://www.cloudflare.com/ips/" target="_blank" rel="noopener">IP di CF</a> periodicamente.</p>
<h2>nginx</h2>
<p>Creare un file /etc/nginx/cloudflare.conf con questo contenuto:</p>
<pre class="language-markup"><code>    set_real_ip_from 103.21.244.0/22;
    set_real_ip_from 103.22.200.0/22;
    set_real_ip_from 103.31.4.0/22;
    set_real_ip_from 104.16.0.0/12;
    set_real_ip_from 108.162.192.0/18;
    set_real_ip_from 131.0.72.0/22;
    set_real_ip_from 141.101.64.0/18;
    set_real_ip_from 162.158.0.0/15;
    set_real_ip_from 172.64.0.0/13;
    set_real_ip_from 173.245.48.0/20;
    set_real_ip_from 188.114.96.0/20;
    set_real_ip_from 190.93.240.0/20;
    set_real_ip_from 197.234.240.0/22;
    set_real_ip_from 198.41.128.0/17;
    set_real_ip_from 199.27.128.0/21;
    set_real_ip_from 2400:cb00::/32;
    set_real_ip_from 2606:4700::/32;
    set_real_ip_from 2803:f800::/32;
    set_real_ip_from 2405:b500::/32;
    set_real_ip_from 2405:8100::/32;

    # use any of the following two
    #real_ip_header CF-Connecting-IP;
    real_ip_header X-Forwarded-For;</code></pre>
<p>Aggiungere poi in /etc/nginx/nginx.conf la riga:</p>
<pre class="language-markup"><code>include /etc/nginx/cloudflare.conf</code></pre>
<p>nel blocco <em>http {}</em>.</p>
<p><a href="https://support.cloudflare.com/hc/en-us/articles/200170706-How-do-I-restore-original-visitor-IP-with-Nginx-">https://support.cloudflare.com/hc/en-us/articles/200170706-How-do-I-restore-original-visitor-IP-with-Nginx-</a></p>
<h2>apache su Ubuntu &lt; 18.04</h2>
<p><em>FIXME</em></p>
<p><a href="https://support.cloudflare.com/hc/en-us/articles/203656534-How-do-I-restore-original-visitor-IP-with-Apache-2-4-">https://support.cloudflare.com/hc/en-us/articles/203656534-How-do-I-restore-original-visitor-IP-with-Apache-2-4-</a></p>
<p> </p>
<p> </p>